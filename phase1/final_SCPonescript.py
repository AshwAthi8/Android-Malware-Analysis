import os
import sys
import csv
from apkutils import APK
import zipfile
import importlib.util
import pickle
from permissions_list_ar import perm_list
spec = importlib.util.spec_from_file_location("androlyze", "/home/ashu8/androlyze.py")
foo = importlib.util.module_from_spec(spec)
spec.loader.exec_module(foo)
trash1 = "./ziperror"
trash2 = "./namerror"
trash3 = "./valuerror"
source = ["/datadrive/SMS","/datadrive/Adware","/datadrive/Banking","/datadrive/Riskware","/datadrive/Benign"]
#foldername = ["SMS","Adware","Banking","Riskware","Benign"]
cs = open('Finaldata.csv',"w")

#wri = csv.writer(cs1)
writer = csv.writer(cs)

def getPermission_apk(nsource, file, entry,flag):
#	print("==========",file,"============")
	file1 = os.path.join(nsource,file)
	#print("=====",file1)
	handle = foo.APK(file1)
	#print(handle)
	temp_per = handle.get_permissions()
	#print(temp_per)
	entry.append(file)
	entry.append(flag)
	for per in temp_per:
		entry.append(per)
	#print(handle.get_files())
	for item in handle.get_files():
		if(item.endswith(".apk")):
			temp_file = open("dump.apk",'wb')
			pickle.dump(item, temp_file, pickle.HIGHEST_PROTOCOL)
			#file2 = os.path.join(source,"dump.apk")
			#print("Nested apk found:")
			file2= "dump.apk"
			handle2 = foo.APK(file2)
			for inperm in handle2.get_permissions():
				entry.append(inperm)
#	print(entry)
	return entry


def convert_csv(infor):
	final_val = ["0" for i in range(len(perm_list)+2)]
	final_val[0] = infor[0]
	final_val[1] = infor[1]
	for i in range(2,len(infor)):
		if infor[i] in perm_list:
			final_val[perm_list.index(infor[i])+2] = "1" 
		else:
			perm_list.append(infor[i])
			final_val.append("1")
	return ";".join(final_val)+"\n"


def main():
	flag = 0
	cs.write("Name;"+"Malicious;"+";".join(perm_list)+"\n")
	print("*****************starting******************")
	for fo in source:
		if(fo == "/datadrive/Benign"):
			flag = "1"
		else:
			flag = "0"
		for file in os.listdir(fo):
			entry = []
			try:
				entry = getPermission_apk(fo, file, entry,flag)
				#print(entry)
				s = convert_csv(entry)
				cs.write(s)
				#print("==================okay!=========")
			except zipfile.BadZipfile:
#				print("error1")
				os.system("cp {} {}".format(os.path.join(fo,file), trash1))
				continue
			except NameError:
#				print("error2")
				os.system("cp {} {}".format(os.path.join(fo,file), trash2))
				continue
			except ValueError:
#				print("error3")
				os.system("cp {} {}".format(os.path.join(fo,file), trash3))
				continue
main()


