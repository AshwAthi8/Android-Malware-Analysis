import os
import sys
import csv
from apkutils import APK
import zipfile
import importlib.util
import pickle

spec = importlib.util.spec_from_file_location("androlyze", "/usr/local/bin/androlyze.py")
foo = importlib.util.module_from_spec(spec)
spec.loader.exec_module(foo)


source = "../Testingfolder"
trash = "../notworking"

cs = open('test.csv',"w")
writer = csv.writer(cs)
temp_file = open("../Testingfolder/dump.apk",'wb')
p=[]

def getPermission_apk(source, file, entry,flag):
	print("==========",file,"============")
	file1 = os.path.join(source,file)
	if(file.endswith(".apk")):
		handle = foo.APK(file1)
		temp_per = handle.get_permissions()
		entry.append(file)
		entry.append(temp_per)
		#if(FLAG == 1):
		#	print(entry,file)
		for item in handle.get_files():
			pickle.dump(item, temp_file, pickle.HIGHEST_PROTOCOL)
			#file2 = os.path.join(source, "dump.apk")
			if(item.endswith(".apk")):
				print("Nested apk found:")
				FLAG = 1
				return getPermission_apk(source, "dump.apk", entry,FLAG)
		FLAG = 0
		return entry

def main():
	FLAG = 0
	for file in os.listdir(source):
		entry = []
		try:
			entry = getPermission_apk(source, file, entry,FLAG)
			print("writing to csv")
			writer.writerow(entry)
		except zipfile.BadZipfile:
			os.system("cp {} {}".format(os.path.join(source,file), trash))
			continue
		except NameError:
			os.system("cp {} {}".format(os.path.join(source,file), trash))
main()

